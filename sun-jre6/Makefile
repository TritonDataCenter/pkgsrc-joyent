# $NetBSD: Makefile,v 1.27 2010/10/23 12:26:33 obache Exp $

# Note: Regen distinfo with PKG_DEFAULT_OPTIONS+=sun-jre-jce
# Note: Update DOWNLOAD_NAME when you update the JRE version

PKGNAME=	sun-jre6-6.0.26

DOWNLOAD_NAME=	Java Runtime Environment (JRE) 6u26

USE_TOOLS+=	pax

WRKSRC=		${WRKDIR}/jdk1.6.0_26/jre

JAVA_WRAPPERS=	java javaws keytool orbd policytool rmid rmiregistry \
		servertool tnameserv
REQD_DIRS=	${JAVA_HOME}
REQD_DIRS+=	${JAVA_HOME}/lib
REQD_DIRS+=	${JAVA_HOME}/lib/applet
REQD_DIRS+=	${JAVA_HOME}/lib/images
REQD_DIRS+=	${JAVA_HOME}/lib/images/cursors
REQD_DIRS+=	${JAVA_HOME}/lib/security
CONF_FILES=	# empty

.include "../../joyent/sun-jre6/Makefile.common"

.sinclude "sfiles-${MACHINE_ARCH}.mk"

.for file in ${SFILES}
CONF_FILES+=	${JAVA_HOME}/lib/${file}.default ${JAVA_HOME}/lib/${file}
.endfor

CHECK_FILES_SKIP+=	${JAVA_HOME}/lib/${EMUL_ARCH}/client/classes.jsa
CHECK_SHLIBS_SUPPORTED=	NO
CHECK_SSP_SUPPORTED=	NO

PKG_OPTIONS_VAR=	PKG_OPTIONS.sun-jre6
PKG_SUPPORTED_OPTIONS=	sun-jre-jce

.include "../../mk/bsd.options.mk"

PLIST_SRC=	PLIST.solaris-i386

PLIST_VARS+=	jce
.if !empty(PKG_OPTIONS:Msun-jre-jce)
DISTFILES=	${DISTNAME}${EXTRACT_SUFX} jce_policy-6.zip
PLIST.jce=	yes
.endif

MAN_PAGES=	java javaws keytool orbd pack200 policytool rmid rmiregistry
MAN_PAGES+=	servertool tnameserv unpack200

post-extract:
	${MKDIR} ${WRKSRC}/.systemPrefs
	${TOUCH} ${WRKSRC}/.systemPrefs/.system.lock
	${TOUCH} ${WRKSRC}/.systemPrefs/.systemRootModFile

do-configure:
	cd ${WRKSRC}/lib; for file in ${SFILES}; do			\
		${MV} -f $$file $$file.default;				\
	done

pre-install:
	# This file is generated the *first* time the package is built on a box
	${RM} -f ${WRKSRC}/lib/servicetag/registration.xml
.if !empty(PKG_OPTIONS:Msun-jre-jce)
	cd ${WRKDIR}/jce ; pax -rw -pe -v . ${WRKSRC}/lib/security
.endif

do-install:
	${INSTALL_PROGRAM_DIR} ${DESTDIR}${JAVA_HOME}
	cd ${WRKSRC} && pax -rwp ma . ${DESTDIR}${JAVA_HOME}
	${CHMOD} -R g-w ${DESTDIR}${PREFIX}
	${INSTALL_MAN_DIR} ${DESTDIR}${JAVA_HOME}/man/man1
.for file in ${MAN_PAGES}
	${INSTALL_MAN} ${WRKSRC}/../man/man1/${file}.1 ${DESTDIR}${JAVA_HOME}/man/man1/
.endfor
	${CHMOD} -R g-w ${DESTDIR}${PREFIX}

#
# re-create sfiles.mk from properties and config files
#
makesfiles:
	${ECHO} >  sfiles-${MACHINE_ARCH}.mk '#	$$Net''BSD$$'
	${ECHO} >> sfiles-${MACHINE_ARCH}.mk '#'
	${ECHO} >> sfiles-${MACHINE_ARCH}.mk '# Created with "make makesfiles"'
	${ECHO} >> sfiles-${MACHINE_ARCH}.mk '# Do not edit this file manually!'
	${ECHO} >> sfiles-${MACHINE_ARCH}.mk '#'
	cd ${WRKSRC}/lib && ${FIND} * -name fontconfig.\* -o		\
		-name \*.properties -o -name \*.properties.\?\? -o	\
		-name \*.cfg -o -name \*.security |			\
	${SED} 's/^/SFILES+=	/' >> ${PKGDIR}/sfiles-${MACHINE_ARCH}.mk

.include "../../mk/bsd.pkg.mk"
