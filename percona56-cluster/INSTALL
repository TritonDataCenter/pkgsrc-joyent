# $NetBSD$

case ${STAGE} in
POST-INSTALL)
	grep '^mysql' /etc/project >/dev/null 2>&1
	if [ $? != 0 ]; then
		projid=`id -u mysql`
		LANG=C projadd -p ${projid} -U mysql -G mysql -K "process.max-file-descriptor=(basic,15000,deny)" mysql
	fi
	if [ ! -d @VARBASE@/log/mysql ]; then
		mkdir -p @VARBASE@/log/mysql
		chown mysql:mysql @VARBASE@/log/mysql
	fi
	grep '^mysql' /etc/logadm.conf >/dev/null 2>&1
	if [ $? != 0 ]; then
		echo "mysql -C 5 -c -s 100m '@VARBASE@/log/mysql/{error,slowquery}.log'" >> /etc/logadm.conf
	fi
	grep '@INTERNAL_IP@' @PKG_SYSCONFDIR@/my.cnf >/dev/null 2>&1
	if [ $? = 0 ]; then
		ipaddr=`ipadm show-addr -po addr net1/_a | sed -e 's/\/.*//'`
		/usr/perl5/bin/perl -pi -e "s/\@INTERNAL_IP\@/${ipaddr}/g" @PKG_SYSCONFDIR@/my.cnf
	fi
	if [ -d @MYSQL_DATADIR@/mysql ]; then
		echo "Skipping MySQL database initialization, as databases already exist."
	else
		# Initialize MySQL
		${PKG_PREFIX}/bin/mysql_install_db --datadir=@MYSQL_DATADIR@ --user=@MYSQL_USER@
	fi
	;;
esac
